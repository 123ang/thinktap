// ThinkTap Database Schema
// PostgreSQL 16 with JSONB support

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User Model
model User {
  id                   String               @id @default(uuid())
  email                String               @unique
  password             String               // bcrypt hashed
  plan                 Plan                 @default(FREE)
  stripeCustomerId     String?              // For payment integration
  subscriptionId       String?              // For subscription tracking
  subscriptionStatus   SubscriptionStatus   @default(INACTIVE)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  quizzes              Quiz[]
  sessions             Session[]
  responses            Response[]

  @@index([email])
  @@map("user")
}

// Quiz Model - Reusable content that can be hosted in multiple sessions
model Quiz {
  id         String     @id @default(uuid())
  title      String
  userId     String
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  questions  Question[]
  sessions   Session[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@index([userId])
  @@map("quiz")
}

enum Plan {
  FREE
  PRO
  FACULTY
  UNIVERSITY
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  PAST_DUE
  CANCELLED
}

// Session Model - A live event/game that uses a Quiz
model Session {
  id         String        @id @default(uuid())
  code       String        @unique // 6-digit numeric code
  lecturerId String
  lecturer   User          @relation(fields: [lecturerId], references: [id], onDelete: Cascade)
  quizId     String?       // Link to the Quiz being played
  quiz       Quiz?         @relation(fields: [quizId], references: [id], onDelete: SetNull)
  mode       SessionMode
  status     SessionStatus @default(CREATED)
  createdAt  DateTime      @default(now())
  endedAt    DateTime?
  responses  Response[]

  @@index([code])
  @@index([lecturerId])
  @@index([quizId])
  @@map("session")
}

enum SessionMode {
  RUSH
  THINKING
  SEMINAR
}

enum SessionStatus {
  CREATED
  ACTIVE
  ENDED
}

// Question Model - Belongs to a Quiz, not a Session
model Question {
  id            String       @id @default(uuid())
  quizId        String
  quiz          Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  type          QuestionType
  question      String       @db.Text
  options       Json?        // JSONB - For MC/MS: ["Option A", "Option B", ...]
  correctAnswer Json         // JSONB - Varies by question type
  timerSeconds  Int?
  order         Int
  createdAt     DateTime     @default(now())
  responses     Response[]

  @@index([quizId])
  @@index([quizId, order])
  @@map("question")
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  MULTIPLE_SELECT
  SHORT_ANSWER
  LONG_ANSWER
}

// Response Model
model Response {
  id             String    @id @default(uuid())
  sessionId      String
  session        Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  questionId     String
  question       Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  userId         String?   // Nullable for anonymous (Seminar mode)
  user           User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  nickname       String?   // Student's nickname for anonymous play
  response       Json      // JSONB - Student's answer
  isCorrect      Boolean?  // Calculated based on question type
  points         Int       @default(0) // Points awarded for this response
  responseTimeMs Int       // Time taken to answer in milliseconds
  submittedAt    DateTime  @default(now())

  @@index([sessionId])
  @@index([questionId])
  @@index([userId])
  @@index([sessionId, nickname]) // For leaderboard queries
  @@map("response")
}
